name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'notebooks/**'
      - 'pyproject.toml'
      - 'pixi.toml'
      - 'Makefile'
      - '.github/workflows/**'
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'notebooks/**'
      - 'pyproject.toml'
      - 'pixi.toml'
      - 'Makefile'
      - '.github/workflows/**'

jobs:
  test:
    name: Tests unitaires et linting
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.5.2
      with:
        pixi-version: '0.32.0'
        cache: true
    
    - name: Install dependencies
      run: pixi install
    
    - name: Run linting (Ruff)
      run: pixi run lint
    
    - name: Run formatting check (Black)
      run: pixi run format-check
    
    - name: Run type checking (Mypy)
      run: pixi run type-check
    
    - name: Run tests with coverage
      run: pixi run test
    
    - name: Check coverage threshold
      run: |
        # Vérifier que la couverture est >= 70%
        coverage_output=$(pixi run python -m pytest --cov=src --cov-report=term-missing --cov-fail-under=70 --no-cov-on-fail 2>&1 || true)
        echo "$coverage_output"
        
        # Extraire le pourcentage de couverture
        if echo "$coverage_output" | grep -q "TOTAL.*[0-9]*%"; then
          coverage_percent=$(echo "$coverage_output" | grep "TOTAL" | awk '{print $4}' | sed 's/%//')
          echo "Coverage percentage: $coverage_percent%"
          
          if (( $(echo "$coverage_percent < 70" | bc -l) )); then
            echo "❌ Coverage is below 70% threshold: $coverage_percent%"
            exit 1
          else
            echo "✅ Coverage meets threshold: $coverage_percent%"
          fi
        else
          echo "⚠️ Could not extract coverage percentage"
        fi
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
  
  build:
    name: Build and package
    runs-on: ubuntu-22.04
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.5.2
      with:
        pixi-version: '0.32.0'
    
    - name: Install dependencies
      run: pixi install
    
    - name: Build package
      run: |
        pip install build
        python -m build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-dist
        path: dist/
  
  notebook-test:
    name: Test des notebooks
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.5.2
      with:
        pixi-version: '0.32.0'
    
    - name: Install dependencies
      run: pixi install
    
    - name: Test notebooks with nbconvert
      run: |
        # Test that notebooks can be executed without errors
        for notebook in notebooks/*.ipynb; do
          echo "Testing notebook: $notebook"
          pixi run python -m nbconvert --to notebook --execute "$notebook" --output-dir /tmp
        done
  
  openshift-deploy:
    name: Déploiement OpenShift (simulé)
    runs-on: ubuntu-22.04
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup OpenShift CLI
      run: |
        # Simulation pour l'instant - à remplacer par la vraie configuration OC
        echo "OpenShift deployment would run here"
        echo "OC CLI would be configured with secrets"
    
    - name: Build Docker image
      run: |
        echo "Building Docker image for OpenShift deployment"
        # Cette étape serait implémentée avec les manifests OpenShift réels
        
    - name: Deploy to OpenShift
      run: |
        echo "Deploying to OpenShift namespace"
        # Cette étape utiliserait les manifests Kubernetes et OC CLI

  ci:
    name: CI Status
    runs-on: ubuntu-22.04
    needs: [test, build, notebook-test]
    if: always()
    
    steps:
    - name: Aggregate CI status
      id: ci-status
      run: |
        # Vérifier le statut de tous les jobs requis
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" && "${{ needs.notebook-test.result }}" == "success" ]]; then
          echo "All required checks passed"
          echo "CI status: success"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "Some checks failed"
          echo "CI status: failure"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Create status badge
      if: always()
      run: |
        if [[ "${{ steps.ci-status.outputs.status }}" == "success" ]]; then
          echo "Creating success badge"
          echo "![CI Status](https://img.shields.io/badge/CI-passing-brightgreen)" > ci-status.md
        else
          echo "Creating failure badge"
          echo "![CI Status](https://img.shields.io/badge/CI-failing-red)" > ci-status.md
        fi
    
    - name: Upload CI status artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ci-status
        path: ci-status.md