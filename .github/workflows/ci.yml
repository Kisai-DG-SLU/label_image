name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  test:
    name: test
    runs-on: ubuntu-22.04
    outputs:
      should_merge: ${{ steps.check_merge.outputs.should_merge }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.5.2
      with:
        pixi-version: 'v0.32.0'
        cache: true
    
    - name: Install dependencies
      run: pixi install
    
    - name: Setup package
      run: pixi run setup
    
    - name: Run linting
      run: pixi run lint
    
    - name: Run tests
      run: pixi run pytest --cov=src --cov-report=html --cov-report=xml --cov-report=term
        
    - name: Check if merge required
      id: check_merge
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/develop" && "${{ github.event_name }}" == "push" ]]; then
          echo "should_merge=true" >> $GITHUB_OUTPUT
        else
          echo "should_merge=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          htmlcov/
          coverage.xml

  build:
    name: build
    runs-on: ubuntu-22.04
    needs: test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.5.2
    - name: Build
      run: |
        pip install build
        python -m build
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-dist
        path: dist/

  notebook-test:
    name: notebook-test
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.5.2
    - name: Test notebooks
      run: |
        for notebook in notebooks/*.ipynb; do
          pixi run python -m nbconvert --to notebook --execute "$notebook" --output-dir /tmp
        done

  ci:
    name: ci
    runs-on: ubuntu-22.04
    needs: [test, build, notebook-test]
    if: always()
    steps:
    - name: Aggregate Status
      run: |
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" && "${{ needs.notebook-test.result }}" == "success" ]]; then
          echo "CI Success"
          exit 0
        else
          echo "CI Failure"
          exit 1
        fi

  deploy-coverage:
    name: Deploy Coverage
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Pixi
      uses: prefix-dev/setup-pixi@v0.5.2
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: coverage-reports
        path: coverage-artifact/
    - name: Extract & Deploy
      run: |
        pixi run python scripts/extract_coverage.py coverage-artifact/coverage.xml coverage.json
    - name: Publish to Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        publish_dir: ./coverage-artifact/htmlcov

  auto-pr:
    name: auto-pr
    needs: [test, ci]
    if: needs.test.outputs.should_merge == 'true' && needs.ci.result == 'success'
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
    
    - name: Install GitHub CLI
      run: |
        type -p gh >/dev/null || sudo apt-get update && sudo apt-get install -y gh
    
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
    
    - name: Create PR
      env:
        GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
      run: |
        gh pr create --base main --head develop \
          --title "Auto PR: ${{ github.event.head_commit.message }}" \
          --body "Automated PR created by CI. Merge managed by auto-merge rules." \
          --label "auto-merge" || echo "PR already exists"